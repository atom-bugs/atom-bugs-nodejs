{"version":3,"file":"NodeDebugger.js","sourceRoot":"","sources":["../lib/NodeDebugger.ts"],"names":[],"mappings":"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","sourcesContent":["'use babel';\n\n// const path = require('path')\n// const EventEmitter = require('events')\nimport { spawn } from 'child_process';\nimport { EventEmitter }  from 'events';\nimport { DebuggerProtocolClient }  from './DebuggerProtocolClient';\n\nexport class NodeDebugger extends EventEmitter {\n\n  private childProcess: any;\n\n  public protocol: DebuggerProtocolClient = new DebuggerProtocolClient();\n  public scriptPath: string;\n  public binary: string = '/usr/local/bin/node';\n  public portNumber: number = 5858;\n\n  public stopScript () {\n    return new Promise<boolean>((resolve) => {\n      this.childProcess.kill();\n      this.protocol.disconnect();\n      resolve(true);\n    })\n  }\n\n  public getCallStack () {\n    let callStack = this.protocol.getCallStack();\n    return callStack.map((frame) => {\n      return {\n        name: frame.functionName,\n        columnNumber: frame.location.columnNumber,\n        lineNumber: frame.location.lineNumber,\n        filePath: frame.location.script.url\n      };\n    });\n  }\n\n  public getScope () {\n    let firstFrame = this.protocol.getFrameByIndex(0);\n    let scope = [...firstFrame.scopeChain];\n    if (firstFrame.this) {\n      scope.unshift({\n        type: 'this',\n        object: firstFrame.this\n      })\n    }\n    return scope.map((s) => {\n      return {\n        name: s.type,\n        value: s.object\n      };\n    });\n  }\n\n  async executeScript () {\n    let args = [\n      `--inspect`,\n      `--debug-brk=${this.portNumber}`,\n      this.scriptPath,\n      '--colors'\n    ]\n    // kill if already running\n    if (this.childProcess) {\n      await this.stopScript();\n    }\n    // process\n    this.childProcess = spawn(this.binary, args, {\n      // options\n    })\n    this.childProcess.stdout.on('data', (res) => this.emit('out', res))\n    this.childProcess.stderr.on('data', (res) => {\n      if (String(res).match(/Waiting for the debugger to disconnect\\.\\.\\./gi)) {\n        this.emit('close');\n      }\n      this.emit('err', res);\n    })\n    this.childProcess.stdout.on('end', (res) => this.emit('out', res))\n    this.childProcess.stderr.on('end', (res) => this.emit('err', res))\n    this.childProcess.on('close', (code) => this.emit('close', code))\n    this.protocol.reset();\n    return this.protocol.connect('localhost', this.portNumber);\n  }\n}\n"]}